#########################################################################################################################################
# This generates a figure which can include the modeled Exploitation rate, natural moratily for fully recruited and
# natural mortality for recruits.
#########################################################################################################################################
# Revision history
## Commented and checked by DK, Decembmer 2015
# Updated in April 2016 by DK
# updated in Jan 2018 to allow for png's to be saved.

#####################################  Function Summary ########################################################
####  
##  This function is used within these files:(a.k.a "dependent files") 
##
##  1:  Update_function_JAGS.r
###############################################################################################################

###############################################################################################################
## This function needs these functions to work (a.k.a. "support files")
# 
##
###############################################################################################################


###############################################################################################################
# Arguments
#output:          The results from the model, either Bayesian or MLE model acceptable
#years:           The years the model was run.
#plt=c('f','m'):  Which plots to produce."f" gives fishing mortality (exploitation rate). "m" gives natural mortality of fully recruited
#                 'mR' is the mortality of the recruits.  Default is c('f','m') so exploitation and fully recruited mortality.
#graphic:         The graphic device.  Default ="screen" which plots the the screen, optionally can save as a pdf.
#type:            The type of model the data came from.  Default ="mcmc", i.e. WinBUGS or similar, optionally can be "mle" for a max likelihood 
#path:            The path to put the figure if saved as a pdf.  Default is blank

# Start the function

exploit.plt <- function(output, years, plt=c('f','m'),graphic="screen", type="mcmc",
                        path="")
{

	 # If years is not specified define years from the data.
  if(missing(years)==T) years<-output$data$iyr
  # If you want to make a pdf figure put it here.
  if(graphic=='pdf') pdf(paste0(path,"exploit.pdf"), width = 11, height = 8.5)
  if(graphic=='png') png(paste0(path,"exploit.png"), width = 11, height = 8.5,res=920,units="in")
  # If just ploting to a window do it like this.
  if(graphic=="screen")windows(11,8.5)
  
  # Set up the plot parameters
  par(mar = c(1, 4, 1, 4), omi = c(0.2, 0.1, 0.2, 0.1))
  
  # if plt specification includes an "m" then the maximum for y = 1
  if("m" %in% plt) ymax=1
  
  # if plt is specified without an "m" then find the maximum of each years estiamte of the 95% quantile of mu to specify the upper bound
  # The 10's are to ensure the ceiling rounds to the proper digit.
  if(!"m" %in% plt) ymax=ceiling(max(apply(output$sims.list$mu, 2, quantile, 0.975))*10)/10
  
  # if plot contains an "f" then we make one of these types of plots.  This is the exploitation rate figure
  if("f" %in% plt)
    {
      # If a bayesian analysis was performed use the mcmc output.
  	  if(type=="mcmc")
  	    {
  	      # DK note:  I have removed the years[-1] in this plot call, it was added in 2014 (2013 version doesn't have it)
  	      # So currently our fishery exploitation shown in this figure means 2014 f is from 2014, it appears to be correct as is.
  	      # Exploitation rate is the black circles
  		    plot(years, output$median$mu, type = 'o', pch = 16, ylab = "", las = 1, mgp = c(0.5, 0.5, 0), 
  		         xlab = "", tcl = -0.3, ylim = c(0, ymax),xlim=c(min(years),max(years)+1), asp = 'xy')
  		    #abline(h=0.25, lty=2)
  		    lines(years, apply(output$sims.list$mu, 2, quantile, 0.025), lty = 2)
  		    lines(years, apply(output$sims.list$mu, 2, quantile, 0.975), lty = 2)
  	    } # end if(type=="mcmc")
    
      # If our output is from a maximum likeliehood type model then this is how we make the plot.    
  	  else if(type=="mle")
  	    {
  		    plot(years, output$MLE$mu, type = 'o', pch = 16, ylab = "", las = 1, mgp = c(0.5, 0.5, 0), 
  		         xlab = "", tcl = -0.3, ylim = c(0, ymax),xlim=c(min(years),max(years)+1), asp = 'xy')
  	    } # end else if(type=="mle")
  	  # annotate the y-axis.
      mtext("Exploitation Rate", 2, 2.5, cex = 1.25)
    } # end if("f" %in% plt)
  
  # If 'mR' is in the plot add recruit natural mortality to the figure.
  if("mR" %in% plt)
    {
    	if(type=="mcmc")
    	  {
    	    # DK note:  I have removed the years+1 in this as well, it was added in 2014 (2013 version doesn't have it)
    	    # problem is it doesn't work with others, but it may be necessary to line up with what we do inshore
    	    # currently our fishery exploitation shown in this figure means 2014 f is from 2014.  Talk to SS!
    	    # Recruit natural mortality is the blue triangles
       		points(years, exp(-output$median$mR), type = 'o', pch = 17,col='blue')
       		lines(years, apply(exp(-output$sims.list$mR), 2, quantile, 0.025), lty = 2,col='blue')
      		lines(years, apply(exp(-output$sims.list$mR), 2, quantile, 0.975), lty = 2,col='blue')
    	  } # end if(type=="mcmc")
      # If our output is from a maximum likeliehood type model then this is how we make the plot.    
    	else if(type=="mle")
    	  {
  		    points(years, exp(-output$MLE$mR), type = 'o', pch = 17,col='blue')
  	    } # end else if(type=="mle")
    } #end if("mR"%in%plt)

  # If 'm' is in the plot add fully recruited natural mortality to the figure.  Fully recruited m is the grey diamonds
  if("m" %in% plt)
    {
  	  if(type=="mcmc")
  	    {
  		    points(years, exp(-output$median$m), type = 'o', pch = 18,col='grey50')
  		    lines(years, apply(exp(-output$sims.list$m), 2, quantile, 0.025), lty = 2,col='grey50')
  		    lines(years, apply(exp(-output$sims.list$m), 2, quantile, 0.975), lty = 2,col='grey50')
  	    } # end if(type=="mcmc")
      # If our output is from a maximum likeliehood type model then this is how we make the plot.    
      else if(type=="mle")
  	    {
  		    points(years, exp(-output$MLE$m), type = 'o', pch = 18,col='grey50')
  	    } # end  else if(type=="mle")

  	  mtext("Natural suvival fraction", 4, 2.5, cex = 1.25)
  	  axis(4, tcl = -0.3, las=1)
    } # end   if("m" %in% plt)

  # if "m" is not in the plot add this as the y axis on the right side of the figure.
  if(!"m" %in% plt)
    {
  	  axis(4, at=1-exp(-pretty(c(0,-log(1-ymax)))),lab=pretty(c(0,-log(1-ymax))),tcl = -0.3, las=1, mgp = c(0.5, 0.5, 0))
  	  mtext("F", 4, 2.5, cex = 1.25)
  	} # end if(!"m" %in% plt)

  # Shut down the graphics device if started.
  if(graphic !='screen') dev.off()

}# end the function


